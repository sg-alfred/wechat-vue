<template>
<header class="header-container">
  <section v-if="goBack" class="head_goback" @click="$router.go(-1)">
    <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg" version="1.1">
      <polyline points="20,10 10,20 20,30" style="fill:none;stroke:rgb(255,255,255);stroke-width:2" />
      <line x1="10" y1="20" x2="30" y2="20" style="stroke:rgb(255,255,255);stroke-width:2" />
    </svg>
  </section>

  <section v-if="headTitle" class="head_title">
    <span class="title_text">{{ headTitle }}</span>
  </section>

  <section v-if="hasDropdown" class="head_dropdown">
    <el-dropdown trigger="click" @command="handleCommand">
      <span class="el-dropdown-link">
        <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg" version="1.1">
          <line x1="10" y1="20" x2="30" y2="20" style="stroke:rgb(255,255,255);stroke-width:2" />
          <line x1="20" y1="10" x2="20" y2="30" style="stroke:rgb(255,255,255);stroke-width:2" />
        </svg>
      </span>
      <el-dropdown-menu sole="dropdown">
        <el-dropdown-item command="groupChat">
          <!--<img src="assets/image/icon-groupchat.png">-->
          <svg class="icon fa-20x" aria-hidden="true">
            <use xlink:href="#icon-message-active" />
          </svg>
          <span>发起群聊</span>
        </el-dropdown-item>
        <el-dropdown-item command="addFriend">
          <!--<img src="assets/image/icon-addFriend.png">-->
          <svg class="icon fa-20x" aria-hidden="true">
            <use xlink:href="#icon-contacts-active" />
          </svg>
          <span>添加好友</span>
        </el-dropdown-item>
        <el-dropdown-item command="scanQRCode">
          <!--<img src="assets/image/icon-scancode.png">-->
          <svg class="icon fa-20x" aria-hidden="true">
            <use xlink:href="#icon-saoyisao" />
          </svg>
          <span>扫一扫</span>
        </el-dropdown-item>
        <el-dropdown-item command="payment">
          <!--<img src="assets/image/icon-payment.png">-->
          <svg class="icon fa-20x" aria-hidden="true">
            <use xlink:href="#icon-shoufukuan" />
          </svg>
          <span>收付款</span>
        </el-dropdown-item>
        <el-dropdown-item command="help">
          <!--<img src="assets/image/icon-help.png">-->
          <svg class="icon fa-20x" aria-hidden="true">
            <use xlink:href="#icon-xiaoxi" />
          </svg>
          <span>帮助与反馈</span>
        </el-dropdown-item>
        <el-dropdown-item command="logout">
          <i class="fa fa-sign-out" aria-hidden="true" />
          <span>退出账号</span>
        </el-dropdown-item>
      </el-dropdown-menu>
    </el-dropdown>
  </section>

  <!-- 搜索按钮 -->
  <router-link v-if="searchType" :to="'/search/' + searchType" class="head_search">
    <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg" version="1.1">
      <circle cx="18" cy="18" r="7" stroke="rgb(255,255,255)" stroke-width="1" fill="none" />
      <line x1="24" y1="24" x2="30" y2="30" style="stroke:rgb(255,255,255);stroke-width:2" />
    </svg>
  </router-link>

  <!-- 搜索输入框 -->
  <slot name="searchFrm" />

  <!-- 微信聊天室的 右上角的用户icon，点击 跳转到 聊天信息 的功能-->
  <!-- 朋友圈右上角的 icon,点击弹出 视频或图片 发布  -->
  <slot name="specialIcon" />

  <!-- 通讯录点击 进入 详细资料后，右上角有用户设置，点击下弹出，比如屏蔽、设置用户名等-->
  <slot name="userOperate" />

  <!-- 汉字，添加好友 -->
  <slot name="addFriendText" />

  <!-- 发送好友申请 按钮 -->
  <!-- 保存 按钮 -->
  <slot name="headerBtn" />
</header>
</template>

<script>
import { mapState, mapActions } from 'vuex';
import { userLogout } from '@/api';
import { localStorage } from '@/utils';

export default {
  name: 'HeaderSection',
  props: {
    headTitle: {
      type: [String, Number],
      required: true,
    },
    goBack: {
      type: Boolean,
      default: false,
    },
    hasDropdown: {
      type: Boolean,
      default: false,
    },
    searchType: {
      type: String,
      default: '',
    },
  },
  data() {
    return {
      messages: 0,
      iconDivStyle: {
        display: 'inline',
        'padding-right': '1rem',
      },
    };
  },
  computed: {
    ...mapState(['isLogin', 'userinfo', 'socket']),
    // 计算未读消息，还是得用 store～
    totalMessages: () => parseInt(Math.random() * 10),
  },
  watch: {
    // 这个应该是要如何监控，本来是监听 socket 的～
    totalMessages: (newvalue) => (this.messages = newvalue),
  },
  created() {
    // 不能是 beforeCreate ? 为什么？这时候是 连数据都还没有初始化吗？
    // 是的，beforeCreate 之后才监听 data，初始化 内部事件。如此，才到了 created！！
    // 放心，created 完了之后 才会 渲染模板 ……
    if (!this.isLogin) {
      console.log('HeaderSection 跳转到 login 界面');
      this.$router.push('/login');
    }
  },
  methods: {
    ...mapActions(['changeLoginInfo']),
    handleCommand(command) {
      if (command === 'logout') {
        this.logout();
      } else {
        this.$router.push('/' + command);
      }
    },
    async logout() {
      try {
        // 断开 socket 连接，这样相当于 又设置了一个 socket!!
        this.socket.close();

        // 这样的话，需要 userLogout 是个异步函数
        const response = await userLogout(); // 更不能直接处理到 data ?
        const result = response.data;

        if (!result.code) {
          this.$message(result.message);

          localStorage('userinfo', null);
          await this.changeLoginInfo(false);

          console.log('退出登录 跳转到 login 界面');
          this.$router.push('/login');
        }
      } catch (err) {
        console.log('退出出错了！', err.message);
      }

      /* this.$http.get('/user/logout').then((response) => {
         let result = response.data
         if (!result.code) {
         this.$message(result.message)

         localStorage('userinfo', null);
         this.changeLoginInfo(false);

         this.$router.push('/login');
         }
         }) */
    },
  },
};
</script>

<style lang="scss" scoped>
.header-container {
  background-color: #434439;
  color: white;
  height: 4.5rem;
  font-size: 1.5rem;
  top: 0;
  position: absolute;
  width: 100%;
  z-index: 100;
}

.head_goback {
  float: left;
  margin: 1rem 0 0 0.5rem;
}

.head_title {
  float: left;
  margin-top: 1.5rem;
  text-align: left;
}

.head_title .title_text {
  margin: 0 0 0 2rem;
}

.head_dropdown,
.head_search {
  float: right;
  margin: 1rem 1rem 0 0.5rem;
}

/* 下拉菜单！ */
.el-dropdown-menu {
  margin-top: 0.6rem;
  padding: 0;
  border: 0;
  background-color: #434439;

  .el-dropdown-menu__item {
    display: flex;
    border-top: 0.01rem solid #000000;
    text-align: left;
    padding: 1.5rem 2rem;
    justify-content: center;
    align-items: center;
    color: white;

    span {
      flex: 0 1 0;
      margin: 0 2rem;
    }

    span:nth-child(2) {
      flex-grow: 1;
    }

    img {
      width: 2.5rem;
    }
  }

  .el-dropdown-menu__item:hover {
    background-color: #000000;
  }
}

.fa-20x {
  font-size: 1.2rem;
}
</style>
